{% extends "home/base.html" %}
{% load static %}
{% load structure_extras %}
{% block addon_css %}
<link rel="stylesheet" href="{% static 'home/css/gprottree.css' %}" media="screen" />
{% endblock %}
{% block content %}

<!-- styles needed? -->
<!-- <link href="{% static 'home/css/prettify.css' %}" rel="stylesheet" media="screen"> -->
<link href="{% static 'home/css/color_picker.css' %}" rel="stylesheet" media="screen">
<link href="{% static 'home/css/bootstrap-responsive.css' %}" rel="stylesheet" media="screen">

<script src="{% static 'home/js/jquery.min.js' %}"></script>
<script src="{% static 'home/js/selection.js' %}"></script>


<script language="Javascript">

  const trackTranslate = {
    '0123': "resultC111100",  '023': "resultC101100",  '123': "resultC011100",
    '012': "resultC111000",  '02': "resultC101000",  '12': "resultC011000",
    '013': "resultC110100",  '03': "resultC100100",  '13': "resultC010100",
    '01': "resultC110000",  '0': "resultC100000",  '1': "resultC010000",
    '23': "resultC001100", '2': "resultC001000", '3': "resultC000100"
  };

  function clear_select_segmentselection(form) {

    ClearSelection('targets')
    //Dealing with csrf token
    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=");
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) c_end = document.cookie.length;
                return unescape(document.cookie.substring(c_start, c_end));
            }
        }
        return "";
    }
    $.ajaxSetup({
        headers: { "X-CSRFToken": getCookie("csrftoken") }
    });
    //Actual post
    var fd = new FormData(form);
    $.ajax({
        type: 'POST',
        url: '/common/targetformread',
        data: fd,
        cache: false,
        processData: false,
        contentType: false,
        'success': function (data) {
            location.href="/alignment/segmentselection";
            console.log('ready!');
        },
    }).fail(function (jqXHR, textStatus, error) {
        alert("Request failed: " + textStatus + error);
    });
    return false;
}
    {% if render_part != "tree" %}
      $(document).ready(function () {
        // "#C0C0C0","#F5F5F5","#696969","#303030"
        // var colorDefault = ["#5a9bd4", "#f15a60", "#808080", "#006600"],
        var colorDefault = ["#C0C0C0","#F5F5F5","#696969","#303030"],
          displayMode  = "classic",
          displaySwitch = false,
          displayStat  = false,
          shortNumber  = true,
          fontSize     = "16px",
          fontFamily   = "Arial";

          gdata = {{ ClassA|safe }};
          gprotein_ID = {{ ClassA_keys|safe }};

        function getArrayFromData(gprotein) {
          var lines = gdata[gprotein].split("\n");
          var table = new Array();
          for (var lindex in lines) {
            table.push(lines[lindex].trim());
          }
          return (table);
        }

        function updateJvenn(gprotein_ID) {
          displaySwitch = false;
          var seriesTable = new Array();
          var num = 0;
          for(var i=1; i<=gprotein_ID.length; i++) {
            seriesTable.push({
              // name: $("#name"+i).val(),
              // data: getArrayFromArea("area"+i)
              name: gprotein_ID[i-1],
              data: getArrayFromData(gprotein_ID[i-1])
            });
          }

            $("#jvenn-container").jvenn({
            series: seriesTable,
            colors: ["rgb(255,255,255)","rgb(255,255,255)","rgb(255,255,255)","rgb(255,255,255)","rgb(255,255,255)"],//["rgb(0,102,0)","rgb(90,155,212)","rgb(241,90,96)","rgb(250,220,91)","rgb(255,117,0)","rgb(192,152,83)"],
            fontSize:   fontSize,
            fontFamily: fontFamily,
            searchInput:  $("#search-field"),
            searchStatus: $("#search-status"),
            displayMode: displayMode,
            shortNumber: shortNumber,
            displaySwitch: displaySwitch,
            displayStat: displayStat,
            fnClickCallback: function() {
              var value = "";
              for (val in this.list) {
                value += this.list[val].split('_')[0].toUpperCase() + "\n";
              }
              $("#input-targets").val(value);
              $("#input-targets").trigger('input');
            }

          });
          var totalCount = 0;
          $(".number-black").each(function(){
            totalCount = totalCount + parseInt($(this).text());
          });
          console.log(totalCount);

          var paper_paths = [];
          paper.setup("test-canvas");
          $("#canvasEllipse svg g g").each(function(index){
            var transform = this.getAttribute("transform").parseTransform();
            paper_paths[index] = new paper.Path(this.firstChild.getAttribute("d"));
            paper_paths[index].scale(transform.scale.x, transform.scale.y);
            paper_paths[index].translate(transform.translate.x, transform.translate.y);
            paper_paths[index].rotate(transform.rotate.a);
            paper_paths[index].strokeColor = new paper.Color(0, 0, 0);
            // Viz
            paper_paths[index].fillColor = '#77f';
          });


          // All possible combinations
          var sets = Array.from(Array(paper_paths.length).keys())
          var combinations = getCombinations([...sets]);
          for (var i=0; i <combinations.length; i++){
            var included = combinations[i];
            track = trackTranslate[included.join('')];
            if (included.length > 0){
              var excluded = sets.filter(value => !included.includes(value));
              // create unique path
              var result = paper_paths[included[0]];  // intersect circle 1 with circle 2
              for (var j=1; j < included.length; j++){
                result = result.intersect(paper_paths[included[j]])
              }
              for (var j=0; j < excluded.length; j++){
                result = result.subtract(paper_paths[excluded[j]])
              }
              // draw path
              var svgPathElement = result.exportSVG(),
              dPath = svgPathElement.getAttribute('d');
              // find the correct ID number location
              var percentage = 200*(parseInt(document.getElementById(track).textContent)/totalCount);
              var gray=componentToHex(255-Math.round(percentage/100*255));
              var color="#"+gray+gray+gray;
              let g = $("#canvasEllipse svg g").get(0); // grab svg panel
              var newElement = document.createElementNS("http://www.w3.org/2000/svg", 'path');
              newElement.setAttribute("d", dPath); //Set path's data
              newElement.setAttribute("fill-opacity", 0.5);
              newElement.style.stroke = "#000000";
              newElement.style.strokeWidth = "1px";
              newElement.style.fill = color;
              g.appendChild(newElement);
            }
          }

        }

        updateJvenn(gprotein_ID)

        $("#ClassA").click(function() {
            $("#input-targets").val('');
            $("#input-targets").trigger('input');
            gprotein_list = {{ ClassA_keys|safe }}
            gdata = {{ ClassA|safe }}
          updateJvenn(gprotein_list);
        });

        $("#ClassB1").click(function() {
            $("#input-targets").val('');
            $("#input-targets").trigger('input');
            gprotein_list = {{ ClassB1_keys|safe }}
            gdata = {{ ClassB1|safe }}
          updateJvenn(gprotein_list);
        });

        $("#CrossClass").click(function() {
            $("#input-targets").val('');
            $("#input-targets").trigger('input');
            gprotein_list = {{ ClassA_keys|safe }}
            gdataA = {{ ClassA|safe }}
            gdataB1 = {{ ClassB1|safe }}
            gdataC = {{ ClassC|safe }}
            gdataF = {{ ClassF|safe }}

            gdata['Gs'] = gdataA['Gs']+gdataB1['Gs']+gdataC['Gs']+gdataF['Gs']
            gdata['Gi/Go'] = gdataA['Gi/Go']+gdataB1['Gi/Go']+gdataC['Gi/Go']+gdataF['Gi/Go']
            gdata['Gq/G11'] = gdataA['Gq/G11']+gdataB1['Gq/G11']+gdataC['Gq/G11']+gdataF['Gq/G11']
            gdata['G12/G13'] = gdataA['G12/G13']+gdataB1['G12/G13']+gdataC['G12/G13']+gdataF['G12/G13']
          updateJvenn(gprotein_list);
        });

        $("#ClassC").click(function() {
            $("#input-targets").val('');
            gprotein_list = {{ ClassC_keys|safe }}
            gdata = {{ ClassC|safe }}
          updateJvenn(gprotein_list);
        });

        $("#ClassF").click(function() {
            $("#input-targets").val('');
            $("#input-targets").trigger('input');
            gprotein_list = {{ ClassF_keys|safe }}
            gdata = {{ ClassF|safe }}
          updateJvenn(gprotein_list);
        });


      });

      {% endif %}
  </script>

<script>
  // Transform parser
  String.prototype.parseTransform = function() {
  	var prop = ['translate', 'matrix', 'rotate', 'skewX', 'skewY', 'scale'];
  	var val = this.match(/(translate|matrix|rotate|skewX|skewY|scale)\(.*?\)/g);
  	var obj = {};
  	if (val) {
  		for (var i = 0, length = val.length; i < length; i++) {
  			var item = val[i];
  			var index = item.indexOf('(');
  			var v = item.substring(index + 1, item.length - 1).split(/\,|\s/);
  			var n = item.substring(0, index);
  			obj[n] = {};
  			switch (n) {
  				case 'translate':
  				case 'scale':
  					obj[n].x = +v[0] || 0;
  					obj[n].y = +v[1] || 0;
  					break;
  				case 'rotate':
  					obj[n].a = +v[0] || 0;
  					obj[n].x = +v[1] || 0;
  					obj[n].y = +v[2] || 0;
  					break;
  				case 'skewX':
  				case 'skewY':
  					obj[n].a = +v[0];
  					break;
  				case 'matrix':
  					obj[n].a = +v[0] || 0;
  					obj[n].b = +v[1] || 0;
  					obj[n].c = +v[2] || 0;
  					obj[n].d = +v[3] || 0;
  					obj[n].e = +v[4] || 0;
  					obj[n].f = +v[5] || 0;
  					break;
  			}
  		}
  	}

  	obj.toString = function() {
  		var builder = [];
  		for (var i = 0, length = prop.length; i < length; i++) {
  			var n = prop[i];
  			var o = this[n];
  			if (!o)
  				continue;
  			switch (n) {
  				case 'translate':
  				case 'scale':
  					builder.push(n + '(' + o.x + ',' + o.y + ')');
  					break;
  				case 'rotate':
  					builder.push(n + '(' + o.a + ' ' + o.x + ' ' + o.y + ')');
  					break;
  				case 'skewX':
  				case 'skewY':
  					builder.push(n + '(' + o.a + ')');
  					break;
  				case 'matrix':
  					builder.push(n + '(' + o.a + ',' + o.b + ',' + o.c + ',' + o.d + ',' + o.e + ',' + o.f + ')');
  					break;
  			}
  		}
  		return builder.join(' ');
  	};

  	return obj;
  };


  function getCombinations(array) {
      console.log(array);
      function iter(temp, index) {
          if (index >= array.length) {
              result.push(temp);
              return;
          }

          iter([...temp, array[index]], index + 1);
          iter(temp, index + 1);
      }

      var result = [];
      iter([], 0);
      return result;
  }
  function componentToHex(c)
  {
      var hex = c.toString(16);
      return hex.length == 1 ? "0" + hex : hex;
  }
</script>

<style type="text/css">
  /* Maintain original width of page */
  @media (min-width: 1600px) {
    #content.container {
      width: 1170px;
    }
  }

  .gprot_blue {
    color: blue;
  }

  .gprot_red {
    color: red;
  }

  .gprot_black {
    color: black;
  }

  .gprot_green {
    color: forestgreen;
  }

  textarea {
      resize: none;
      overflow: hidden;
  }
</style>

{% if render_part != "tree" %}
<div class="container">
  <p style="clear:both;text-align:left">
    <div class="btn-group" role="group" aria-label="Basic example">
        <button id="ClassA" class="btn btn-primary">A</button>
        <button id="ClassB1" class="btn btn-primary">B1</button>
        <button id="ClassC" class="btn btn-primary">C</button>
        <button id="ClassF" class="btn btn-primary">F</button>
        <button id="CrossClass" class="btn btn-primary">Cross</button>
    </div>
  </p>
  <div class="row-fluid">
    <div class="span12">
      <div class="row-fluid">
        <div class="span6">
          <div class="row-fluid">
            <div id="jvenn-container"></div>
          </div>
        </div>

        <div class="span6">
          <div>
            <p> Click on an area of the venn diagram or a receptor clade on the phylogenetic G-protein selectivity tree to display the respective receptor sets: </p>
          </div>
          <form id='target-input-form' method="post" enctype="multipart/form-data">
            <textarea name="input-targets" id="input-targets" style="width: 50%;" oninput="auto_grow(this)"></textarea>
            <button onclick="clear_select_segmentselection(document.getElementById('target-input-form'))" type="button" class="btn btn-success" style="float: right;"> Make sequence alignment </button>
          </form>

          <!--             <button onclick="location.href='/alignment/segmentselection'" type="button" class="btn btn-success"> Make sequence alignment </button> -->
        </div>
        <canvas id="test-canvas" style="display:none";></canvas>
        </div>
      </div>
    </div>
  </div>
  <hr>
</div>
{% endif %}

<script>
  ! function($) {
    $(function() {
      window.prettyPrint && prettyPrint()
    })
  }(window.jQuery)
</script>


<script type="text/javascript" charset="utf-8">
  var selectivitydata = {{ selectivitydata|safe }};
  var data = {{ ClassA|safe }};
  var list = {{ ClassA_keys|safe }};

  function auto_grow(element) {
    element.style.height = "5px";
    element.style.height = (element.scrollHeight)+"px";
  }
  $(document).ready(function(){

    paper.install(window);
    });
</script>

{% if render_part != "venn" %}
  <div id="selectivitydata" class="text-center">
  </div>

  <div class="row text-center">
      <span class="gprot_blue">&#11044; G&alpha;<sub>s</sub></span>
      <span class="gprot_red">&#11044; G&alpha;<sub>i/o</sub></span>
      <span class="gprot_black">&#11044; G&alpha;<sub>q/11</sub></span>
      <span class="gprot_green">&#11044; G&alpha;<sub>12/13</sub></span>
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class="panel-body">
        <div class='col-md-10'>
          <p><strong>GPCR selectivity tree.</strong> Concentric circles illustrate the G protein-coupling selectivity of each GPCR: the four dots depict both primary and secondary G protein coupling (from inside to outside: <a href="family/100_001_001/">G&alpha;<sub>s</sub></a>,
            <a href="family/100_001_002/">G&alpha;<sub>i/o</sub></a>, <a href="family/100_001_003/">G&alpha;<sub>q/11</sub></a>, <a href="family/100_001_004/">G&alpha;<sub>12/13</sub></a>). Tree nodes can be highlighted and selected to retrieve
            clade-specific receptor sets, which can be used in dedicated segment specific sequence alignments.</p>
        </div>
      </div>
    </div>
  </div>
  <hr>
{% endif %}

<div class='col-md-12'>
  <h4>Reference:</h4>
  <p>
    We used the G protein transducer imformation from the
    <a href='http://www.guidetopharmacology.org'>GuideToPharmacology</a> (IUPHAR): </p>
  <p>


    Armstrong, J. F., Faccenda, E., Harding, S. D., Pawson, A. J., Southan, C., Sharman, J. L., Campo, B., Cavanagh, D. R., Alexander, S. P. H., Davenport, A. P., Spedding, M., Davies, J. A. & NC-IUPHAR.<br>
    <b>The IUPHAR/BPS Guide to PHARMACOLOGY in 2020: extending immunopharmacology content and introducing the IUPHAR/MMV Guide to MALARIA PHARMACOLOGY.</b><br>
    <a href="https://doi.org/10.1093/nar/gkz951" target="_blank"><i>Nucleic Acids Res</i></a> <b>48</b>, D1006–D1021 (2020).<br>
    [PMID:<a href="http://www.ncbi.nlm.nih.gov/pubmed/31691834" target="_blank">31691834</a>]
  </p>
  <p>
    Inoue, A., Raimondi, F., Kadji, F. M. N., Singh, G., Kishi, T., Uwamizu, A., Ono, Y., Shinjo, Y., Ishida, S., Arang, N., Kawakami, K., Gutkind, J. S., Aoki, J. & Russell, R. B.<br>
    <b>Illuminating G-Protein-Coupling Selectivity of GPCRs.</b> <br>
    <i><a href="https://doi.org/10.1016/j.cell.2019.04.044" target="_blank">Cell</a></i> <b>177</b>, 1933-1947.e25 (2019).<br>
    [PMID:<a href="https://pubmed.ncbi.nlm.nih.gov/31160049/" target="_blank">31160049</a>]
  </p>
  <p>
    Avet, C., Mancini, A., Breton, B., Gouill, C. L., Hauser, A. S., Normand, C., Kobayashi, H., Gross, F., Hogue, M., Lukasheva, V., Morissette, S., Fauman, E., Fortin, J.-P., Schann, S., Leroy, X., Gloriam, D. E. & Bouvier, M.<br>
    <b>Selectivity Landscape of 100 Therapeutically Relevant GPCR Profiled by an Effector Translocation-Based BRET Platform.</b><br>
    <i><a href="https://www.biorxiv.org/content/10.1101/2020.04.20.052027v1" target="_blank">bioRxiv</a></i> 2020.04.20.052027 (2020).<br>
    <b>doi:</b> <a href=" https://doi.org/10.1101/2020.04.20.052027" target="_blank">10.1101/2020.04.20.052027</a>
  </p>

</div>

{% endblock %}
{% block addon_js %}
<script src="{% static 'home/js/d3.min.js' %}"></script>
<script src="{% static 'home/js/newick.js' %}"></script>
{% if render_part != "venn" %}
  <script src="{% static 'home/js/gprotselectivitytree.js' %}"></script>
{% endif %}
<script src="{% static 'home/js/paper-full.js' %}"></script>
<script src="{% static 'home/js/paper-core.js' %}"></script>
<script src="{% static 'home/js/bootstrap-colorpicker.min.js' %}"></script>
<script src="{% static 'home/js/canvas2svg.js' %}"></script>
<script src="{% static 'home/js/jvenn.js' %}"></script>
<script src="{% static 'home/js/nv.d3.min.js' %}"></script>
<script src="{% static 'home/js/saveSvgAsPng.js' %}"></script>

{% endblock %}
